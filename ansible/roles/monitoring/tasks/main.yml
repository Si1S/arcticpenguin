---
- name: Ensure monitoring user exists
  ansible.builtin.user:
    name: "{{ monitoring_user }}"
    shell: /bin/bash
    create_home: true
    groups: docker
    append: true

- name: Ensure {{ monitoring_dir }} directory exists
  ansible.builtin.file:
    path: "{{ monitoring_dir }}"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
    mode: "0755"

- name: Clone arcticpenguin repository to temp
  ansible.builtin.git:
    repo: "{{ monitoring_repo }}"
    dest: "{{ monitoring_tmp_dir }}"
    version: "{{ monitoring_branch }}"
    update: yes

- name: Copy ONLY monitoring/ folder to {{ monitoring_dir }}
  ansible.builtin.copy:
    src: "{{ monitoring_tmp_dir }}/monitoring/"
    dest: "{{ monitoring_dir }}/"
    remote_src: yes
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
  notify: restart monitoring stack

- name: Cleanup temporary arcticpenguin clone
  ansible.builtin.file:
    path: "{{ monitoring_tmp_dir }}"
    state: absent

# PROMETHEUS
- name: Ensure prometheus directory exists
  ansible.builtin.file:
    path: "{{ monitoring_dir }}/prometheus"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
    mode: "0755"
  notify: restart prometheus

- name: Render prometheus.yml from template
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ monitoring_dir }}/prometheus/prometheus.yml"
    mode: "0644"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
  notify: restart prometheus

- name: Render prometheus web.yml from template
  ansible.builtin.template:
    src: prometheus_web.yml.j2
    dest: "{{ monitoring_dir }}/prometheus/web.yml"
    mode: "0644"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
  notify: restart prometheus

- name: Ensure prometheus rules directory exists
  ansible.builtin.file:
    path: "{{ monitoring_dir }}/prometheus/rules"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
    mode: "0755"
  notify: restart prometheus

- name: Render prometheus rule files from templates
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ monitoring_dir }}/prometheus/rules/{{ item }}"
    mode: "0644"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
  loop: "{{ prometheus_rules_files }}"
  notify: restart prometheus

# BLACKBOX EXPORTER
- name: Ensure blackbox exporter config directory exists
  ansible.builtin.file:
    path: "{{ monitoring_dir }}/blackbox_exporter"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
    mode: "0755"
  notify: restart blackbox-exporter

- name: Render blackbox exporter modules config from template
  ansible.builtin.template:
    src: blackbox_modules.yml.j2
    dest: "{{ monitoring_dir }}/blackbox_exporter/blackbox.yml"
    mode: "0644"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
  notify: restart blackbox-exporter

# ALERTMANAGER
- name: Ensure alertmanager config directory exists
  ansible.builtin.file:
    path: "{{ monitoring_dir }}/alertmanager"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
    mode: "0755"
  notify: restart alertmanager

- name: Render alertmanager config from template
  ansible.builtin.template:
    src: alertmanager.yml.j2
    dest: "{{ monitoring_dir }}/alertmanager/alertmanager.yml"
    mode: "0644"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
  notify: restart alertmanager

# .env
- name: Render monitoring .env from template
  ansible.builtin.template:
    src: monitoring.env.j2
    dest: "{{ monitoring_dir }}/.env"
    mode: "0640"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_user }}"
  notify: restart monitoring stack

- meta: flush_handlers
