---
- name: Ensure webapp user exists
  ansible.builtin.user:
    name: "{{ webapp_user }}"
    shell: /bin/bash
    create_home: true
  tags: ['webapp', 'users']

- name: Ensure postgres-app user exists
  ansible.builtin.user:
    name: "{{ postgres_user }}"
    shell: /bin/false
    create_home: false
    system: true
  tags: ['webapp', 'users']

- name: Ensure {{ webapp_dir }} directory exists
  ansible.builtin.file:
    path: "{{ webapp_dir }}"
    state: directory
    owner: "{{ webapp_user }}"
    group: "{{ webapp_user }}"
    mode: "0755"
  tags: ['webapp', 'fs']

- name: Clone repository to temp
  ansible.builtin.git:
    repo: "{{ arctic_repo }}"
    dest: "{{ webapp_tmp_dir }}"
    version: "{{ webapp_version }}"
    update: true
    depth: 1
    single_branch: true
  tags: ['webapp', 'deploy']

- name: Copy ONLY webapp/ folder to {{ webapp_dir }}
  ansible.builtin.copy:
    src: "{{ webapp_tmp_dir }}/webapp/"
    dest: "{{ webapp_dir }}/"
    remote_src: true
    owner: "{{ webapp_user }}"
    group: "{{ webapp_user }}"
    mode: preserve
  notify: restart webapp stack
  tags: ['webapp', 'deploy']

- name: Cleanup temporary clone
  ansible.builtin.file:
    path: "{{ webapp_tmp_dir }}"
    state: absent
  tags: ['webapp', 'deploy']

- name: Render docker-compose .env
  no_log: true
  ansible.builtin.template:
    src: webapp.env.j2
    dest: "{{ webapp_dir }}/.env"
    mode: "0640"
    owner: "{{ webapp_user }}"
    group: "{{ webapp_user }}"
  notify: restart webapp stack
  tags: ['webapp', 'config']

- name: Render Symfony .env (local)
  no_log: true
  ansible.builtin.template:
    src: symfony.env.j2
    dest: "{{ webapp_dir }}/symfony/.env"
    mode: "0644"
    owner: "{{ webapp_user }}"
    group: "{{ webapp_user }}"
  notify: restart webapp php
  tags: ['webapp', 'config']

- name: Ensure Symfony writable directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ webapp_dir }}/symfony/var",            owner: "{{ webapp_user }}",    group: "{{ webapp_user }}",    mode: "0755" }
    - { path: "{{ webapp_dir }}/symfony/var/cache/prod", owner: "{{ webapp_www_user }}", group: "{{ webapp_www_group }}", mode: "0755" }
    - { path: "{{ webapp_dir }}/symfony/var/log",        owner: "{{ webapp_www_user }}", group: "{{ webapp_www_group }}", mode: "0755" }
  tags: ['webapp', 'fs']

- name: Ensure nginx log directory exists
  ansible.builtin.file:
    path: "{{ webapp_dir }}/logs/nginx"
    state: directory
    owner: "{{ webapp_www_user }}"
    group: "{{ webapp_www_group }}"
    mode: "0750"
  tags: ['webapp', 'fs']

- name: Ensure Postgres base directory exists
  ansible.builtin.file:
    path: "{{ webapp_pg_base_dir }}"
    state: directory
    owner: "{{ postgres_user }}"
    group: "{{ postgres_user }}"
    mode: "0750"
  tags: ['webapp', 'db', 'fs']

- name: Ensure DB data directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ postgres_user }}"
    group: "{{ postgres_user }}"
    mode: "0700"
  loop: "{{ webapp_pg_dirs }}"
  notify: restart webapp db
  tags: ['webapp', 'db', 'fs']

- name: Composer install (with temporary outbound rule)
  when: webapp_run_composer | bool
  tags: ['webapp', 'composer']
  block:
    - name: Check if Composer vendor autoload exists
      ansible.builtin.stat:
        path: "{{ webapp_dir }}/symfony/vendor/autoload.php"
      register: composer_vendor

    - name: Temporarily allow HTTP/HTTPS outbound for Composer
      when:
        - webapp_use_ufw_temp_rules | bool
        - not composer_vendor.stat.exists
      community.general.ufw:
        rule: allow
        direction: out
        proto: "{{ webapp_temp_egress_proto }}"
        port: "{{ webapp_temp_egress_ports }}"
        comment: "{{ webapp_temp_ufw_comment }}"

    - name: Install PHP dependencies with Composer (only if missing)
      when: not composer_vendor.stat.exists
      become: true
      become_user: "{{ webapp_user }}"
      community.general.composer:
        command: install
        working_dir: "{{ webapp_composer_workdir }}"
        no_dev: true
        optimize_autoloader: true
        no_scripts: true
      notify: restart webapp php

  always:
    - name: Remove temporary outbound rule for Composer
      when:
        - webapp_use_ufw_temp_rules | bool
        - not composer_vendor.stat.exists
      community.general.ufw:
        rule: allow
        direction: out
        proto: "{{ webapp_temp_egress_proto }}"
        port: "{{ webapp_temp_egress_ports }}"
        comment: "{{ webapp_temp_ufw_comment }}"
        delete: true

